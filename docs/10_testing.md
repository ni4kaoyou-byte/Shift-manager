# 10_testing.md — テスト戦略（MVP）

- プロダクト：飲食店向け シフト管理SaaS（個人開発MVP）
- 方針：API先行 + 縦スライス開発に合わせた検証を行う
- 更新：v0.1

---

## 0. 目的

- FR-01〜FR-20 の成立を段階的に検証する
- 仕様変更に強い最小テストセットを維持する
- リリース前に「運用が破綻しない」ことを確認する

---

## 1. テストレイヤ

### L1: Unit Test（高速）

- 対象
  - Go: `domain`, `usecase`
  - React: `hooks`, `utils`, 純粋関数
- 目的
  - 業務ルールの回帰防止

### L2: Integration Test（API/DB）

- 対象
  - handler + usecase + repository の接続
  - 権限・store境界チェック
- 目的
  - APIの契約とDB整合性の確認

### L3: E2E Test（主要フロー）

- 対象
  - ブラウザ操作での実API接続フロー
- 目的
  - ユーザー導線が壊れていないことを確認

---

## 2. 使用ツール

- Go: `go test`
- React: `Vitest + Testing Library`
- E2E: `Playwright`

---

## 3. テスト環境

- DBスキーマは `db/migrations/0001_init` を適用したものを使う
- テストユーザーはロール別に最低2種用意
  - 店長（manager）
  - スタッフ（staff）
- 期間データは `draft/published` の両状態を準備する

---

## 4. MVP必須E2Eシナリオ（優先順）

### E2E-01 ログイン

- 条件
  - 正しい資格情報でログインできる
  - 未認証アクセスは保護される
- 対応要件
  - FR-01, FR-02

### E2E-02 参加（招待）

- 条件
  - 店長が招待を作成できる
  - スタッフが招待で参加できる
- 対応要件
  - FR-03, FR-04

### E2E-03 希望提出

- 条件
  - スタッフが希望提出できる
  - 店長が提出状況で反映を確認できる
- 対応要件
  - FR-06, FR-07, FR-09, FR-10

### E2E-04 公開

- 条件
  - 店長が割当編集し公開できる
  - スタッフが確定シフトを閲覧できる
- 対応要件
  - FR-12, FR-14, FR-15, FR-18

### E2E-05 変更申請

- 条件
  - スタッフが欠勤/変更申請できる
  - 店長が承認/却下できる
  - 承認後の反映が確認できる
- 対応要件
  - FR-16, FR-17, FR-18

### E2E-06 履歴

- 条件
  - 公開後変更が履歴に残る
  - 履歴は店長のみ閲覧できる
- 対応要件
  - FR-20

---

## 5. APIテスト観点（最低限）

- 認証
  - JWTなし/無効JWTで401
- 認可
  - staffが店長専用APIへアクセスして403
- バリデーション
  - 必須欠落/不正形式で400
- テナント境界
  - 他店舗データへアクセスできない

---

## 6. 画面テスト観点（最低限）

- ローディング/エラー表示が適切
- 送信後に画面状態が更新される
- モバイル幅で主要導線が操作可能（スタッフ導線）

---

## 7. リリース前チェックリスト

1. `go test ./...` が通る
2. フロントユニットテストが通る
3. E2E-01〜E2E-06 が通る
4. 主要エンドポイントの401/403/400が確認できる
5. 監査ログ記録が確認できる

---

## 8. 不具合対応ルール

- バグ修正は再現テストを先に追加してから実装する
- 重大バグ（認可漏れ/履歴欠損）は最優先で修正する
- 修正後は関連E2Eを再実行してからマージする
