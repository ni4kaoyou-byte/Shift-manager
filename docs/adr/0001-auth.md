# ADR 0001: Authentication and Authorization Strategy（MVP）

- Date: 2026-02-15
- Status: Accepted
- Owners: shift-manager

---

## Context

- MVPは店長/スタッフの2ロールで、店舗単位のアクセス分離が必須。
- 要件上、未認証アクセス防止とロール別操作制御が必要（FR-01, FR-02）。
- 技術スタックは Go API + React + Supabase を採用している。

---

## Decision

1. 認証基盤は Supabase Auth（メール/パスワード）を採用する  
2. クライアントは Supabase JWT を `Authorization: Bearer <token>` でAPIへ送る  
3. Go API側でJWTの検証（署名/期限/sub）を行う  
4. 認可は `store_memberships` の `role` と `status` で判定する  
5. `401` は未認証、`403` は認証済みだが権限不足として使い分ける  
6. 重要操作（公開、承認/却下、公開後変更）は `audit_logs` に記録する  

---

## Consequences

### Positive

- 認証実装を短期間で立ち上げられる
- 店舗境界（`store_id`）とロール境界をAPIで統一制御できる
- 監査対象操作の追跡が可能になる

### Negative

- Supabase依存が増える
- JWT検証ロジックと鍵更新対応が必要になる
- API層での認可実装漏れがあるとリスクが高い

---

## Alternatives Considered

1. Goで自前認証を実装  
却下理由: MVP初期の実装コストと運用負荷が高い。

2. フロント側のみで認可を行う  
却下理由: セキュリティ上不十分で、API直叩きに耐えられない。

3. 店舗境界チェックをRLSのみに依存  
却下理由: API層でも境界チェックを持つ二重防御を優先するため。

---

## Follow-ups

1. APIミドルウェアでJWT検証と `request context` へのユーザー注入を実装する  
2. `manager` / `staff` のエンドポイント権限マトリクスを作成する  
3. RLS方針をADRで追加し、API層との責務境界を明文化する  
